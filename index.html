<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é’³å·¥è¯ç†è®ºå†å¹´çœŸé¢˜ï¼ˆæœºæ¢°åŸºç¡€éƒ¨åˆ†ï¼‰</title>
  <style>
    :root {
      --correct-color: #2e7d32;
      --wrong-color: #c62828;
      --primary-color: #4CAF50;
      --timer-color: #ff4757;
      --progress-color: #2196F3;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      line-height: 1;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }

    .container {
      max-width: 800px;
      margin: 10px auto;
      padding: 10px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* ============= é»˜è®¤å­—ä½“å¤§å°ï¼ˆå…¶ä»–é¡µé¢ä¿æŒä¸å˜ï¼‰ ============= */
    .question p, .options label, 
    #finalResult h2, .score,
    #finalResult h3, .wrong-question p,
    .wrong-question .options div {
      font-size: 60px !important;
    }

    .options label {
      display: flex;
      align-items: center;
      margin: 1px 0;
      cursor: pointer;
      padding: 4px;
      border-radius: 5px;
      transition: background 0.2s;
    }

    .options label:hover {
      background-color: #f0f0f0;
    }

    .options input[type="radio"] {
      width: 50px;
      height: 50px;
      margin-right: 20px;
      accent-color: var(--primary-color);
      cursor: pointer;
    }

    .feedback {
      font-size: 50px;
      padding: 10px;
      margin: 10px 0;
      border-radius: 10px;
      display: none;
    }

    /* ============= ä»…ç¼©å°ç­”é¢˜é¡µï¼ˆ#quizScreenï¼‰çš„å­—ä½“ ============= */
    #quizScreen .question p,
    #quizScreen .options label,
    #quizScreen .feedback,
    #quizScreen #finalResult h2,
    #quizScreen .score,
    #quizScreen #finalResult h3,
    #quizScreen .wrong-question p,
    #quizScreen .wrong-question .options div {
      font-size: 30px !important; /* ç¼©å°ä¸€åŠ */
    }

    #quizScreen .options input[type="radio"] {
      width: 25px !important; /* ç¼©å°ä¸€åŠ */
      height: 25px !important; /* ç¼©å°ä¸€åŠ */
      margin-right: 10px !important; /* ç¼©å°ä¸€åŠ */
    }

    /* ç§»åŠ¨ç«¯é€‚é…ï¼ˆä»…ç­”é¢˜é¡µç¼©å°ï¼‰ */
    @media (max-width: 768px) {
      #quizScreen .question p,
      #quizScreen .options label,
      #quizScreen .feedback,
      #quizScreen #finalResult h2,
      #quizScreen .score,
      #quizScreen #finalResult h3,
      #quizScreen .wrong-question p,
      #quizScreen .wrong-question .options div {
        font-size: 20px !important; /* ç¼©å°ä¸€åŠ */
      }

      #quizScreen .options input[type="radio"] {
        width: 20px !important;
        height: 20px !important;
        margin-right: 7.5px !important;
      }
    }

    /* ============= å…¶ä»–æ ·å¼ä¿æŒä¸å˜ ============= */
    .correct-feedback { 
      background: color-mix(in srgb, var(--correct-color) 10%, white);
      border-left: 5px solid var(--correct-color);
    }

    .wrong-feedback { 
      background: color-mix(in srgb, var(--wrong-color) 10%, white);
      border-left: 5px solid var(--wrong-color);
    }

    .action-btn {
      padding: 10px 20px;
      margin: 10px 0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
      background: var(--primary-color);
      color: white;
      font-weight: bold;
    }

    .action-btn:hover { 
      background: color-mix(in srgb, var(--primary-color), black 15%);
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .back-btn { background: #2196F3; }
    .analysis-btn { background: #9C27B0; }
    .wrong-btn { background: #FF5722; }

    .timer-container {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 1000;
      width: 90%;
      max-width: 500px;
    }

    .timer {
      font: bold 18px/1.1 sans-serif;
      color: var(--timer-color);
      background: rgba(255, 255, 255, 0.9);
      padding: 0px 0px;
      border-radius: 2px;
      box-shadow: 0 2px 3px rgba(0,0,0,0.1);
      margin-bottom: 0px;
      text-align: center;
      width: 100%;
    }

    .progress-container {
      width: 100%;
      background: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
    }

    .progress-bar {
      height: 10px;
      background: var(--progress-color);
      width: 0%;
      transition: width 0.3s;
    }

    .button-group { 
      display: flex;
      gap: 20px;
      margin-top:15px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .result-container { 
      max-height: 80vh; 
      overflow-y: auto; 
      padding: 15px; 
      border: 1px solid #ddd; 
      border-radius: 5px; 
      margin-top: 20px; 
    }

    .input-group { margin: 8px 0; }
    .input-group h3 { margin: 10px 0; color: #333; font-size: 18px; }

    .input-field, .name-select, .category-select {
      width: 100%;
      max-width: 400px;
      padding: 8px;
      margin: 5px 0;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .input-field:focus, .name-select:focus, .category-select:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    .wrong-question { 
      color: black; 
      margin-bottom: 7px;
      padding: 8px;
      background: #fff3e0;
      border-radius: 8px;
    }

    .correct-answer { color: var(--correct-color); font-weight: bold; }
    .wrong-answer { text-decoration: line-through; color: var(--wrong-color); }
    .credit { font-size: 20px; color: red; margin-bottom: 25px; text-align: center; }

    .password-box, .result-screen, .analysis-screen { 
      text-align: center; 
      margin: 40px 0; 
    }

    .rank-link {
      color: #2196F3;
      text-decoration: none;
      margin-top: 10px;
      display: block;
      font-size: 14px;
      cursor: pointer;
    }

    .rank-link:hover {
      text-decoration: underline;
    }

    .rank-box, .analysis-box {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      z-index: 9999;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      display: none;
    }

    .rank-header, .analysis-header {
      font-size: 24px;
      color: var(--primary-color);
      margin-bottom: 20px;
      text-align: center;
    }

    .rank-item {
      display: flex;
      justify-content: space-between;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }

    .rank-number { width: 40px; font-weight: bold; }
    .rank-name { flex: 2; }
    .rank-score { flex: 1; text-align: right; color: var(--timer-color); }

    .close-btn {
      position: absolute;
      right: 15px;
      top: 15px;
      cursor: pointer;
      font-size: 24px;
      color: #999;
    }

    .category-tag {
      display: inline-block;
      padding: 3px 8px;
      background: #e3f2fd;
      color: #1976d2;
      border-radius: 4px;
      font-size: 14px;
      margin-right: 5px;
      margin-bottom: 5px;
    }

    .knowledge-item {
      margin-bottom: 8px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 5px;
    }

    .knowledge-name {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .knowledge-progress {
      height: 10px;
      background: #e0e0e0;
      border-radius: 5px;
      overflow: hidden;
    }

    .knowledge-progress-bar {
      height: 100%;
      background: var(--primary-color);
    }

    .mode-selector {
      margin: 20px 0;
      text-align: center;
    }

    .mode-btn {
      padding: 10px 20px;
      margin: 0 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      background: #e0e0e0;
      transition: all 0.3s;
    }

    .mode-btn.active {
      background: var(--primary-color);
      color: white;
    }

    /* åŠ è½½åŠ¨ç”» */
    .loader {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loader-spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid var(--primary-color);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    .loader-text {
      font-size: 18px;
      color: #333;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loader" class="loader">
    <div class="loader-spinner"></div>
    <div class="loader-text">åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</div>
  </div>

  <div id="rankBox" class="rank-box">
    <div class="close-btn" onclick="closeRank()">Ã—</div>
    <div class="rank-header">ğŸ† å®æ—¶æ’è¡Œæ¦œ</div>
    <div id="rankList"></div>
  </div>

  <div id="analysisBox" class="analysis-box">
    <div class="close-btn" onclick="closeAnalysis()">Ã—</div>
    <div class="analysis-header">ğŸ“Š çŸ¥è¯†ç‚¹åˆ†æ</div>
    <div id="knowledgeAnalysis"></div>
  </div>

  <div class="container">
    <div id="passwordScreen" class="password-box">
      <div class="credit">ç”±é«˜å·ä¸€èŒ Mré» åˆ¶ä½œ</div>
      
      <div class="mode-selector">
        <button id="practiceMode" class="mode-btn active" onclick="setMode('practice')">ç»ƒä¹ æ¨¡å¼</button>
        <button id="examMode" class="mode-btn" onclick="setMode('exam')">è€ƒè¯•æ¨¡å¼</button>
      </div>
      
      <div class="input-group">
        <h3>è¯·é€‰æ‹©æ‚¨çš„å§“åï¼š</h3>
        <select id="nameSelect" class="name-select">
          <option value="" disabled selected>è¯·é€‰æ‹©å§“å</option>
        </select>
      </div>
      
      <div class="input-group" id="categoryGroup">
        <h3>é€‰æ‹©é¢˜ç›®åˆ†ç±»ï¼ˆå¯é€‰ï¼‰ï¼š</h3>
        <select id="categorySelect" class="category-select" multiple>
          <option value="all" selected>å…¨éƒ¨é¢˜ç›®</option>
          <option value="èºçº¹">èºçº¹</option>
          <option value="é½¿è½®">é½¿è½®</option>
          <option value="è½´æ‰¿">è½´æ‰¿</option>
          <option value="åˆ¶å›¾">æœºæ¢°åˆ¶å›¾</option>
          <option value="ææ–™">ææ–™</option>
          <option value="ä¼ åŠ¨">ä¼ åŠ¨æœºæ„</option>
        </select>
      </div>
      
      <button class="action-btn" onclick="checkPassword()">å¼€å§‹åšé¢˜</button>
      <a href="javascript:void(0)" class="rank-link" onclick="showRank()">æŸ¥çœ‹å®æ—¶æ’è¡Œæ¦œ â†’</a>
    </div>
    
    <div id="quizScreen" style="display: none;">
      <div class="timer-container">
        <div id="timer" class="timer">05:00</div>
        <div class="progress-container">
          <div id="progressBar" class="progress-bar"></div>
        </div>
      </div>
      
      <div id="currentQuestion"></div>
      <div class="feedback" id="feedback"></div>
      
      <div class="button-group">
        <button class="action-btn" id="confirmBtn" onclick="checkAnswer()" style="display: none;">ç¡®å®šç­”æ¡ˆ</button>
        <button class="action-btn" id="nextBtn" onclick="showNextQuestion()" style="display: none;">ä¸‹ä¸€é¢˜</button>
      </div>
      <div class="feedback" id="feedback"></div>
    </div>

    <div id="resultScreen" class="result-screen" style="display: none;">
      <div id="finalResult">
        <h2 style="color:#2196F3"></h2>
        <div class="score"></div>
        <h3></h3>
      </div>
      
      <div class="button-group">
        <button class="action-btn back-btn" onclick="location.reload()">è¿”å›é¦–é¡µ</button>
        <button class="action-btn analysis-btn" onclick="showAnalysis()">æŸ¥çœ‹çŸ¥è¯†ç‚¹åˆ†æ</button>
        <button class="action-btn wrong-btn" onclick="reviewWrongQuestions()">å¤ä¹ é”™é¢˜</button>
      </div>
      
      <div class="result-container" id="wrongQuestionsContainer" style="display: none;">
        <h3>é”™é¢˜å›é¡¾</h3>
        <div id="wrongQuestionsList"></div>
      </div>
    </div>
  </div>

  <!-- å¼•å…¥é¢˜åº“æ–‡ä»¶ -->
  <script src="questions.js"></script>
  
  <script>
    // é…ç½®é¡¹
    const CONFIG = {
      storageKey: 'quiz_rank',
      wrongQuestionsKey: 'wrong_questions',
      totalQuestions: 20,
      totalTime: 300, // æ€»è€ƒè¯•æ—¶é—´ï¼ˆ5åˆ†é’Ÿ=300ç§’ï¼‰
      scorePerQuestion: 5,
      categories: {
        "èºçº¹": ["èºçº¹ç±»å‹", "èºçº¹å‚æ•°", "èºçº¹åº”ç”¨"],
        "é½¿è½®": ["é½¿è½®ç±»å‹", "é½¿è½®å‚æ•°", "é½¿è½®ä¼ åŠ¨"],
        "è½´æ‰¿": ["è½´æ‰¿ç±»å‹", "è½´æ‰¿ä»£å·", "è½´æ‰¿åº”ç”¨"],
        "åˆ¶å›¾": ["è§†å›¾è¡¨è¾¾", "å°ºå¯¸æ ‡æ³¨", "æ ‡å‡†ä»¶ç”»æ³•"],
        "ææ–™": ["é‡‘å±ææ–™", "éé‡‘å±ææ–™", "ææ–™æ€§èƒ½"],
        "ä¼ åŠ¨": ["å¸¦ä¼ åŠ¨", "é“¾ä¼ åŠ¨", "é½¿è½®ä¼ åŠ¨"]
      }
    };

    // å­¦ç”Ÿåå•
    const studentList = [
      "ç¬¬ä¸€ç»„","ç¬¬äºŒç»„","ç¬¬ä¸‰ç»„","ç¬¬å››ç»„","é‚±æ—¥å¼º","é»„ç«æ˜","æ¨åé©°","æœ±ç«‹ä¹¾","é‚±è€€é“­","è‘›é‡‘é¹","æ¢çš“è½©",
      "éƒ­æ©ç‘","ç¨‹å‰‘è±ª","ç½—è¿œæ˜Š","æ±ŸæŸå† ","å¢å®å¢","é‚“é•‡æƒ","é»„åº†é£",
      "è°¢æ³½é«˜","å†¯éºŸæ–Œ","å¢å­è±ª","å¼ è¶…åŸ","é»„æä¿Š","é»„æ°¸éœ–","æé¼",
      "é‚“é¸¿é•‡","é»„åŸ¹è½©","å½­å®¶ä¹","é»„æ–°é“§","è°¢å›½æ°¸","æ›¾ä¿Šçƒ½","æ¨æ°¸å»º",
      "é™ˆç»§è´¤","åˆ˜é‡‘ç¿","è¢ä¹æ¸…","æœ±å† å¸†","å¼ å¹¿éš†","æ¢å›½äº®","æ¢ç‡•è¾°",
      "é™ˆæ±Ÿå—","æ—æµ©å®‡","è”¡ä¼Ÿæ°","æ—æ¾æµ·","å•ä»æ‰","éŸ¦æ‚¦","çŸ³æ±Ÿæ¶›",
      "å®é¢¢ç„¶","åˆ˜ä»˜ç…œæ¯…","æ¢å¿—é‘«","èµ–å…†éœ†","å¼ æ¢“é’¥","å†¯å­å¼º","é™ˆå®¶åº†",
      "é™ˆé”¡åŸº","è‹å­èª"
    ];

    // åº”ç”¨çŠ¶æ€
    let currentQuestionIndex = 0;
    let selectedQuestions = [];
    let userAnswers = {};
    let userName = '';
    let countdownTimer;
    let remainingTime = CONFIG.totalTime;
    let currentMode = 'practice'; // 'practice' æˆ– 'exam'
    let selectedCategories = ['all'];
    let wrongQuestions = [];

    // åˆå§‹åŒ–åº”ç”¨
    function initApp() {
      showLoader();
      
      // åˆå§‹åŒ–å­¦ç”Ÿé€‰æ‹©ä¸‹æ‹‰æ¡†
      const nameSelect = document.getElementById('nameSelect');
      nameSelect.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©å§“å</option>';
      studentList.forEach(student => {
        const option = document.createElement('option');
        option.value = student;
        option.textContent = student;
        nameSelect.appendChild(option);
      });
      nameSelect.disabled = false;

      // åˆå§‹åŒ–åˆ†ç±»é€‰æ‹©
      const categorySelect = document.getElementById('categorySelect');
      categorySelect.addEventListener('change', function() {
        selectedCategories = Array.from(this.selectedOptions).map(opt => opt.value);
        if (selectedCategories.includes('all')) {
          selectedCategories = ['all'];
          this.querySelector('option[value="all"]').selected = true;
        }
      });

      // åˆå§‹åŒ–æœ¬åœ°å­˜å‚¨
      localStorage.getItem(CONFIG.storageKey) || localStorage.setItem(CONFIG.storageKey, JSON.stringify({}));
      localStorage.getItem(CONFIG.wrongQuestionsKey) || localStorage.setItem(CONFIG.wrongQuestionsKey, JSON.stringify({}));
      
      hideLoader();
    }

    // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
    function showLoader() {
      document.getElementById('loader').style.display = 'flex';
    }

    // éšè—åŠ è½½åŠ¨ç”»
    function hideLoader() {
      document.getElementById('loader').style.display = 'none';
    }

    // è®¾ç½®è€ƒè¯•æ¨¡å¼
    function setMode(mode) {
      currentMode = mode;
      document.getElementById('practiceMode').classList.toggle('active', mode === 'practice');
      document.getElementById('examMode').classList.toggle('active', mode === 'exam');
      
      if (mode === 'practice') {
        document.getElementById('categoryGroup').style.display = 'block';
      } else {
        document.getElementById('categoryGroup').style.display = 'none';
      }
    }

    // è·å–æ’è¡Œæ¦œæ•°æ®
    function getRankData() {
      return JSON.parse(localStorage.getItem(CONFIG.storageKey)) || {};
    }

    // è·å–é”™é¢˜æœ¬æ•°æ®
    function getWrongQuestionsData() {
      return JSON.parse(localStorage.getItem(CONFIG.wrongQuestionsKey)) || {};
    }

    // æ›´æ–°æœ€é«˜åˆ†è®°å½•
    function updateHighScore(name, newScore, usedTime) {
      const rankData = getRankData();
      if (!rankData[name] || newScore > rankData[name].score ||
        (newScore === rankData[name].score && usedTime < rankData[name].time)) {
        rankData[name] = { score: newScore, time: usedTime };
        localStorage.setItem(CONFIG.storageKey, JSON.stringify(rankData));
      }
    }

    // æ›´æ–°é”™é¢˜æœ¬
    function updateWrongQuestions(name, wrongs) {
      const wrongData = getWrongQuestionsData();
      wrongData[name] = wrongs;
      localStorage.setItem(CONFIG.wrongQuestionsKey, JSON.stringify(wrongData));
    }

    // ç”Ÿæˆæ’è¡Œæ¦œ
    function generateRankList() {
      const rankData = getRankData();
      const sortedList = Object.entries(rankData).sort((a, b) => {
        if (b[1].score !== a[1].score) return b[1].score - a[1].score;
        return a[1].time - b[1].time; // åˆ†æ•°ç›¸åŒæ—¶ç”¨æ—¶çŸ­çš„æ’å‰
      }).slice(0, 300);

      let html = sortedList.length ? '' : '<div style="text-align:center; color:#666;">æš‚æ— æˆç»©è®°å½•</div>';
      sortedList.forEach(([name, data], index) => {
        html += `<div class="rank-item">
          <div class="rank-number">${index + 1}.</div>
          <div class="rank-name">${name}</div>
          <div class="rank-score">${data.score}åˆ† (${formatTime(data.time)})</div>
        </div>`;
      });
      document.getElementById('rankList').innerHTML = html;
    }

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    // æ˜¾ç¤ºæ’è¡Œæ¦œ
    function showRank() {
      generateRankList();
      document.getElementById('rankBox').style.display = 'block';
    }

    // å…³é—­æ’è¡Œæ¦œ
    function closeRank() {
      document.getElementById('rankBox').style.display = 'none';
    }

    // æ˜¾ç¤ºçŸ¥è¯†ç‚¹åˆ†æ
    function showAnalysis() {
      const analysisData = analyzeKnowledge();
      let html = '';
      
      // æŒ‰åˆ†ç±»æ˜¾ç¤ºçŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ
      for (const [category, stats] of Object.entries(analysisData.categoryStats)) {
        const percentage = Math.round((stats.correct / stats.total) * 100);
        
        html += `<div class="knowledge-item">
          <div class="knowledge-name">${category} (${stats.correct}/${stats.total})</div>
          <div class="knowledge-progress">
            <div class="knowledge-progress-bar" style="width: ${percentage}%"></div>
          </div>
        </div>`;
      }
      
      document.getElementById('knowledgeAnalysis').innerHTML = html;
      document.getElementById('analysisBox').style.display = 'block';
    }

    // å…³é—­çŸ¥è¯†ç‚¹åˆ†æ
    function closeAnalysis() {
      document.getElementById('analysisBox').style.display = 'none';
    }

    // æ£€æŸ¥å¯†ç /å§“å
    function checkPassword() {
      const selectedName = document.getElementById('nameSelect').value;
      if (!selectedName) return alert('è¯·é€‰æ‹©å§“åï¼');
      
      userName = selectedName;
      document.getElementById('passwordScreen').style.display = 'none';
      document.getElementById('quizScreen').style.display = 'block';
      
      initializeQuiz();
      
      if (currentMode === 'exam') {
        startTimer();
      } else {
        document.getElementById('timer').textContent = 'ç»ƒä¹ æ¨¡å¼';
      }
    }

    // å¼€å§‹è®¡æ—¶å™¨
    function startTimer() {
      countdownTimer = setInterval(() => {
        remainingTime--;
        updateTimerDisplay();
        
        // æ›´æ–°è¿›åº¦æ¡
        const progressPercentage = ((CONFIG.totalTime - remainingTime) / CONFIG.totalTime) * 100;
        document.getElementById('progressBar').style.width = `${progressPercentage}%`;
        
        if (remainingTime <= 0) {
          clearInterval(countdownTimer);
          submitQuiz();
        }
      }, 1000);
    }

    // æ›´æ–°è®¡æ—¶å™¨æ˜¾ç¤º
    function updateTimerDisplay() {
      const minutesLeft = Math.floor(remainingTime / 60);
      const secondsLeft = remainingTime % 60;
      document.getElementById('timer').textContent =
        `${String(minutesLeft).padStart(2, '0')}:${String(secondsLeft).padStart(2, '0')}`;
    }

    // åˆå§‹åŒ–æµ‹éªŒ
    function initializeQuiz() {
      showLoader();
      
      // å»é‡å¤„ç†
      const uniqueQuestions = [];
      const seenQuestions = new Set();
      
      questions.forEach(q => {
        if (!seenQuestions.has(q.question)) {
          seenQuestions.add(q.question);
          uniqueQuestions.push(q);
        }
      });
      
      // æ ¹æ®åˆ†ç±»ç­›é€‰é¢˜ç›®
      let filteredQuestions = uniqueQuestions;
      if (currentMode === 'practice' && !selectedCategories.includes('all')) {
        filteredQuestions = uniqueQuestions.filter(q => 
          q.categories && q.categories.some(cat => selectedCategories.includes(cat))
      ); 
        }
      
      // éšæœºé€‰æ‹©é¢˜ç›®
      selectedQuestions = filteredQuestions
        .sort(() => 0.5 - Math.random())
        .slice(0, CONFIG.totalQuestions);
      
      // é‡ç½®çŠ¶æ€
      currentQuestionIndex = 0;
      userAnswers = {};
      wrongQuestions = [];
      
      showQuestion(currentQuestionIndex);
      document.getElementById('confirmBtn').style.display = 'block';
      document.getElementById('nextBtn').style.display = 'none';
      
      hideLoader();
    }

    // æ˜¾ç¤ºé¢˜ç›®
    function showQuestion(index) {
      const q = selectedQuestions[index];
      let html = `<div class="question"><p>ç¬¬${index + 1}é¢˜ï¼š${q.question}</p>`;
      
      // æ˜¾ç¤ºåˆ†ç±»æ ‡ç­¾ï¼ˆç»ƒä¹ æ¨¡å¼ï¼‰
      if (currentMode === 'practice' && q.categories) {
        html += `<div style="margin-bottom: 10px;">`;
        q.categories.forEach(cat => {
          html += `<span class="category-tag">${cat}</span>`;
        });
        html += `</div>`;
      }
      
      html += `<div class="options">`;
      q.options.forEach(option => html += `
        <label>
          <input type="radio" name="currentQ" value="${option[0]}">
          ${option}
        </label>`);
      html += `</div></div>`;
      
      document.getElementById('currentQuestion').innerHTML = html;
      
      // æ¢å¤ä¹‹å‰çš„é€‰æ‹©ï¼ˆå¦‚æœæœ‰ï¼‰
      if (userAnswers[index]) {
        document.querySelector(`input[name="currentQ"][value="${userAnswers[index]}"]`).checked = true;
      }
      
      // æ›´æ–°è¿›åº¦æ˜¾ç¤º
      if (currentMode === 'exam') {
        document.getElementById('progressBar').style.width = `${(index / selectedQuestions.length) * 100}%`;
      }
    }

    // æ£€æŸ¥ç­”æ¡ˆ
    function checkAnswer() {
      const selected = document.querySelector('input[name="currentQ"]:checked');
      if (!selected) return alert('è¯·é€‰æ‹©ç­”æ¡ˆï¼');

      const q = selectedQuestions[currentQuestionIndex];
      const feedback = document.getElementById('feedback');
      userAnswers[currentQuestionIndex] = selected.value;

      // æ£€æŸ¥æ˜¯å¦æ­£ç¡®
      const isCorrect = selected.value === q.correct;
      
      // æ›´æ–°åé¦ˆ
      feedback.className = isCorrect ? 'feedback correct-feedback' : 'feedback wrong-feedback';
      feedback.innerHTML = isCorrect ? 
        "âœ… å›ç­”æ­£ç¡®ï¼" : 
        `âŒ å›ç­”é”™è¯¯ï¼æ­£ç¡®ç­”æ¡ˆï¼š<span class="correct-answer">${q.correct}</span>`;
      
      // è®°å½•é”™é¢˜
      if (!isCorrect) {
        wrongQuestions.push({
          question: q,
          userAnswer: selected.value,
          questionIndex: currentQuestionIndex
        });
      }

      // æ›´æ–°æŒ‰é’®
      document.getElementById('nextBtn').textContent =
        currentQuestionIndex === selectedQuestions.length - 1 ? 'æäº¤ç­”æ¡ˆ' : 'ä¸‹ä¸€é¢˜';

      feedback.style.display = 'block';
      document.getElementById('confirmBtn').style.display = 'none';
      document.getElementById('nextBtn').style.display = 'block';
    }

    // æ˜¾ç¤ºä¸‹ä¸€é¢˜æˆ–æäº¤æµ‹éªŒ
    function showNextQuestion() {
      document.getElementById('feedback').style.display = 'none';
      document.getElementById('nextBtn').style.display = 'none';

      if (currentQuestionIndex < selectedQuestions.length - 1) {
        currentQuestionIndex++;
        showQuestion(currentQuestionIndex);
        document.getElementById('confirmBtn').style.display = 'block';
      } else {
        submitQuiz();
      }
    }

    // æäº¤æµ‹éªŒ
    function submitQuiz() {
      clearInterval(countdownTimer);
      const usedTime = CONFIG.totalTime - remainingTime;

      // è®¡ç®—æ­£ç¡®é¢˜æ•°
      let correct = selectedQuestions.reduce((acc, q, index) =>
        acc + (userAnswers[index] === q.correct ? 1 : 0), 0);

      const totalScore = correct * CONFIG.scorePerQuestion;
      
      // æ›´æ–°æ’è¡Œæ¦œå’Œé”™é¢˜æœ¬
      if (currentMode === 'exam') {
        updateHighScore(userName, totalScore, usedTime);
      }
      updateWrongQuestions(userName, wrongQuestions);

      // æ˜¾ç¤ºç»“æœ
      document.getElementById('quizScreen').style.display = 'none';
      document.getElementById('resultScreen').style.display = 'block';

      const resultName = document.querySelector('#finalResult h2');
      const resultScore = document.querySelector('#finalResult .score');
      const resultCount = document.querySelector('#finalResult h3');

      resultName.textContent = `è€ƒç”Ÿå§“åï¼š${userName}`;
      resultScore.textContent = `å¾—åˆ†ï¼š${totalScore}åˆ†${currentMode === 'exam' ? ` (ç”¨æ—¶ï¼š${formatTime(usedTime)})` : ''}`;
      resultCount.textContent = `æ­£ç¡®ï¼š${correct}é¢˜ / æ€»è®¡ï¼š${CONFIG.totalQuestions}é¢˜`;
      
      window.scrollTo(0, 0);
    }

    // åˆ†æçŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ
    function analyzeKnowledge() {
      const categoryStats = {};
      const knowledgeStats = {};
      
      selectedQuestions.forEach((q, index) => {
        // åˆ†ç±»ç»Ÿè®¡
        if (q.categories) {
          q.categories.forEach(cat => {
            categoryStats[cat] = categoryStats[cat] || {correct: 0, total: 0};
            categoryStats[cat].total++;
            if(userAnswers[index] === q.correct) categoryStats[cat].correct++;
          });
        }
        
        // çŸ¥è¯†ç‚¹ç»Ÿè®¡
        if (q.knowledge) {
          q.knowledge.forEach(know => {
            knowledgeStats[know] = knowledgeStats[know] || {correct: 0, total: 0};
            knowledgeStats[know].total++;
            if(userAnswers[index] === q.correct) knowledgeStats[know].correct++;
          });
        }
      });
      
      return {
        categoryStats,
        knowledgeStats
      };
    }

    // å¤ä¹ é”™é¢˜
    function reviewWrongQuestions() {
      const wrongQuestionsContainer = document.getElementById('wrongQuestionsContainer');
      const wrongQuestionsList = document.getElementById('wrongQuestionsList');
      
      if (wrongQuestionsContainer.style.display === 'none') {
        wrongQuestionsList.innerHTML = '';
        
        if (wrongQuestions.length === 0) {
          wrongQuestionsList.innerHTML = '<p>æ²¡æœ‰é”™é¢˜éœ€è¦å¤ä¹ ï¼</p>';
        } else {
          wrongQuestions.forEach((wrong, index) => {
            const q = wrong.question;
            let html = `<div class="wrong-question">
              <p>ç¬¬${wrong.questionIndex + 1}é¢˜ï¼š${q.question}</p>
              <div class="options">`;
            
            q.options.forEach(option => {
              const isCorrect = option[0] === q.correct;
              const isWrong = option[0] === wrong.userAnswer;
              let optionClass = '';
              
              if (isCorrect) optionClass = 'correct-answer';
              if (isWrong && !isCorrect) optionClass = 'wrong-answer';
              
              html += `<div class="${optionClass}">${option}</div>`;
            });
            
            html += `</div></div>`;
            wrongQuestionsList.innerHTML += html;
          });
        }
        
        wrongQuestionsContainer.style.display = 'block';
      } else {
        wrongQuestionsContainer.style.display = 'none';
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initApp();
      setMode('practice'); // é»˜è®¤ç»ƒä¹ æ¨¡å¼
    });
  </script>
</body>
</html>
